<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'/>
  <meta name='viewport' content='width=device-width, initial-scale=1'/>
  <title>ClassAid</title>
  <link rel='manifest' href='/manifest.json'>
  <link rel='icon' href='/assets/icon-192.png'>
  <meta name='theme-color' content='#0b0f0d'>
  <link rel='stylesheet' href='/css/style.css'>

  <!-- One-time reset: /index.html?reset=1 -->
  <script>
  if (location.search.includes('reset=1')) {
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if (window.caches) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch(e) {}
      const u = new URL(location.href);
      u.searchParams.delete('reset');
      u.searchParams.set('sw','off'); // skip SW after reset
      u.searchParams.set('fresh', Date.now());
      location.replace(u.toString());
    })();
  }
  </script>

  <!-- One-time cleanup: /index.html?sw=clean to register cleanup SW -->
  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    if (qs.get('sw') === 'clean' && 'serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js?ts=' + Date.now()).catch(()=>{});
    }
  })();
  </script>
  <style>
    /* a touch more breathing room for the hero */
    .hero{background:linear-gradient(180deg,rgba(34,227,146,.08),transparent);border:1px solid var(--border);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px 0;font-size:28px}
    .hero p{margin:0;opacity:.85}
    .cards{display:grid;gap:16px}
    @media(min-width:900px){.cards{grid-template-columns:1.6fr 1fr 1fr}}
  </style>
</head>
<body class='density-comfortable theme-emerald'>
  <header class='header'>
    <div class='container'>
      <div class='brand'>
        <img src='/assets/icon-192.png' alt='ClassAid'>
        <h1>ClassAid</h1>
        <div class='sub' id='hdrProfile'>Profile: default • Mode: Web</div>
        <div class='quickmenu'>
          <div class='dropdown' id='qm-dropdown'>
            <button class='qbtn' onclick='UI.openQuickMenu()'>☰</button>
            <div class='dropdown-panel'>
              <button onclick='UI.toggleFocus()'>Toggle Focus</button>
              <a href='/pages/customize.html'>Customize</a>
              <button onclick='UI.switchProfile()'>Switch/Create Profile</button>
              <button onclick="location.href='/index.html?reset=1'">Reset (SW+cache)</button>
            </div>
          </div>
        </div>
      </div>
      <nav class='nav' id='nav'>
        <a data-mod='dashboard' href='/index.html'>Dashboard</a>
        <a data-mod='assignments' href='/pages/assignments.html'>Assignments</a>
        <a data-mod='gpa' href='/pages/gpa.html'>GPA</a>
        <a data-mod='flashcards' href='/pages/flashcards.html'>Flashcards</a>
        <a data-mod='essay' href='/pages/essay.html'>Essay</a>
        <a data-mod='import' href='/pages/import.html'>Import</a>
        <a data-mod='customize' href='/pages/customize.html'>Customize</a>
      </nav>
    </div>
  </header>

  <div class='page'>
    <div class='container'>

      <!-- Hero / intro -->
      <div class='hero card'>
        <h2>Welcome back 👋</h2>
        <p>Stay on top of assignments, GPA, study decks, and essays. Pick a theme in <a href='/pages/customize.html'>Customize</a>, quick-add with <kbd>Ctrl</kbd>+<kbd>K</kbd>, and back up anytime with <kbd>Ctrl</kbd>+<kbd>S</kbd>.</p>
      </div>

      <!-- Spacious dashboard cards -->
      <div class='cards' style='margin-top:16px'>
        <div class='card'>
          <h3>Today</h3>
          <div id='todaySummary' class='muted'>Loading…</div>
          <div class='row' style='margin-top:12px'>
            <button class='btn brand' id='btnQuick'>+ Quick Assignment</button>
            <a class='btn' href='/pages/assignments.html'>Open Assignments</a>
          </div>
        </div>

        <div class='card'>
          <h3>GPA Snapshot</h3>
          <div class='row'>
            <div><div class='muted'>Unweighted</div><div id='gpaUnw' style='font-size:30px;font-weight:800'>—</div></div>
            <div><div class='muted'>Weighted</div><div id='gpaW' style='font-size:30px;font-weight:800'>—</div></div>
          </div>
          <div class='muted' id='gpaTip' style='margin-top:8px'>Add classes in GPA to see snapshots.</div>
        </div>

        <div class='card'>
          <h3>Shortcuts</h3>
          <div class='row' id='shortcuts'></div>
          <p class='muted' style='margin-top:10px'>Customize in <a href='/pages/customize.html'>Customize</a>.</p>
        </div>
      </div>

    </div>
  </div>

  <footer class='footer'><div class='container'>© <span id='year'></span> ClassAid. All rights reserved.</div></footer>
  <div class='modal' id='modal'><div class='panel'></div></div>

  <script src='/js/store.js'></script>
  <script src='/js/ui.js'></script>
  <script src='/js/app.js'></script>

  <script src='/js/gpa.js'></script>
  <script src='/js/assignments.js'></script>

  <script>
  (function(){
    // Don’t auto-register a SW; only when ?sw=clean is present (handled in <head>)
    const y = document.getElementById('year'); if(y) y.textContent = new Date().getFullYear();

    // build shortcuts row
    const sc = (Store.settings().shortcuts||['assignments','gpa','flashcards']).map(id=>{
      const map = {assignments:'Assignments', gpa:'GPA', flashcards:'Flashcards', essay:'Essay', import:'Import'};
      const href = id==='assignments'? '/pages/assignments.html' : id==='gpa'? '/pages/gpa.html' : id==='flashcards'? '/pages/flashcards.html' : id==='essay'? '/pages/essay.html' : '/pages/import.html';
      return {id, label: map[id]||id, href};
    });
    const row = document.getElementById('shortcuts');
    sc.forEach(s=>{ const a=document.createElement('a'); a.className='btn'; a.href=s.href; a.textContent=s.label; row.appendChild(a); });

    // today summary
    function refresh(){
      const a = Store.get().assignments||[];
      const now = new Date();
      const today = a.filter(x=> new Date(x.due).toDateString() === now.toDateString());
      const open = a.filter(x=> x.status!=='done');
      let html='';
      if(today.length===0) html+='<div>No assignments due today.</div>';
      else{
        html+='<div><b>'+today.length+'</b> due today:</div><ul>';
        today.slice(0,6).forEach(t=> html+='<li class=\"muted\">'+t.title+' <span class=\"pill\">'+ new Date(t.due).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) +'</span></li>');
        html+='</ul>';
      }
      html+='<div style=\"margin-top:8px\" class=\"muted\">Open: '+open.length+' • Total: '+a.length+'</div>';
      document.getElementById('todaySummary').innerHTML = html;
    }
    refresh(); setInterval(refresh, 60000);
    document.getElementById('btnQuick').onclick = UI.quickAddAssignment;

    const g = GPA.compute();
    document.getElementById('gpaUnw').textContent = isNaN(g.unweighted)?'—':g.unweighted.toFixed(2);
    document.getElementById('gpaW').textContent = isNaN(g.weighted)?'—':g.weighted.toFixed(2);
    document.getElementById('gpaTip').style.display = isNaN(g.unweighted)?'block':'none';

    UI.applySettings(); // theme, density, focus, profile label
  })();
  </script>
</body>
</html>