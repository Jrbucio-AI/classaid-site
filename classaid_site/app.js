let deferredPrompt;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('installBtn')?.style?.setProperty('display','inline-flex')});document.getElementById('installBtn')?.addEventListener('click',async e=>{e.preventDefault();if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null});const QUEUE='waitlistQueue',form=document.getElementById('waitlist');const toast=m=>{const t=document.getElementById('toast');if(!t)return;t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)};form?.addEventListener('submit',ev=>{ev.preventDefault();const email=new FormData(form).get('email');const q=JSON.parse(localStorage.getItem(QUEUE)||'[]');q.push({email,at:Date.now()});localStorage.setItem(QUEUE,JSON.stringify(q));form.reset();toast('Added â€” will sync when online.');syncQueue()});async function syncQueue(){const q=JSON.parse(localStorage.getItem(QUEUE)||'[]');if(!navigator.onLine||q.length===0)return;const next=[];for(const i of q){try{const res=await fetch('api/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:i.email})});if(!res.ok)throw 0}catch{next.push(i)}}localStorage.setItem(QUEUE,JSON.stringify(next));if(next.length===0)toast('All signups synced.')}window.addEventListener('online',syncQueue);if('serviceWorker'in navigator){navigator.serviceWorker.register('sw.js?v=8').then(()=>{if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage('{"cmd":"RESET_IF_OLD"}')}})}