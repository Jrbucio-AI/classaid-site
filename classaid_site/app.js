let d;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();d=e;document.getElementById('installBtn').style.display='inline-block'});document.getElementById('installBtn').onclick=async()=>{if(!d)return;d.prompt();await d.userChoice;d=null};const k='waitlist';const f=document.getElementById('waitlist');if(f){f.addEventListener('submit',e=>{e.preventDefault();const email=new FormData(f).get('email');const q=JSON.parse(localStorage.getItem(k)||'[]');q.push({email,at:Date.now()});localStorage.setItem(k,JSON.stringify(q));f.reset();const t=document.getElementById('toast');t.textContent='Added â€” will sync when online';t.style.display='block';setTimeout(()=>t.style.display='none',2200);sync()})}async function sync(){const q=JSON.parse(localStorage.getItem(k)||'[]');if(!navigator.onLine||q.length===0)return;const next=[];for(const i of q){try{const r=await fetch('/api/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:i.email})});if(!r.ok)throw 0}catch{next.push(i)}}localStorage.setItem(k,JSON.stringify(next))}window.addEventListener('online',sync);if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js')}