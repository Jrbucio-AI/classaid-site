<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ClassAid — SPA</title>
<meta name="description" content="Modern student OS: planner, GPA, study games, sticky notes.">
<meta name="theme-color" content="#070e0c">
<style>
:root{--bg:#070e0c;--panel:#0f1714;--muted:#1a2622;--ink:#e8f2ee;--sub:#b7c9c1;--brand:#00e090;--brand-2:#16b4df;--glow:0 18px 46px rgba(0,0,0,.38);--fontScale:1;--lh:1.55}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:calc(16px*var(--fontScale))/var(--lh) Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:var(--brand);text-decoration:none}
small,.small{color:var(--sub);font-size:calc(12px*var(--fontScale))}
.container{max-width:1200px;margin:0 auto;padding:24px}
.nav{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(7,14,12,.6);border-bottom:1px solid var(--muted);z-index:30}
.nav .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;gap:10px;align-items:center}
.brand svg{width:26px;height:26px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:14px;background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#06120d;font-weight:800;box-shadow:var(--glow);transform:translateZ(0);transition:transform .15s,filter .15s,background .15s}
.btn:hover{transform:translateY(-1px);filter:saturate(1.07)}
.btn:active{transform:translateY(0)}
.btn.alt{background:transparent;border:1px solid var(--brand);color:var(--ink)}
.btn.ghost{background:transparent;border:1px solid var(--muted);color:var(--ink)}
.hero{padding:84px 0 40px;background:radial-gradient(1400px 700px at 70% -10%, rgba(0,224,144,.16), transparent),radial-gradient(1000px 520px at 0% -10%, rgba(22,180,223,.18), transparent)}
h1{font-size:calc(48px*var(--fontScale));line-height:1.08;margin:10px 0 6px}
p.lead{font-size:calc(18px*var(--fontScale));color:var(--sub);max-width:760px}
.input{display:flex;gap:10px;margin-top:12px}
.input input,.input select,.input textarea{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--muted);background:#0b1411;color:var(--ink)}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:22px}
.card{background:var(--panel);border:1px solid var(--muted);border-radius:20px;padding:20px;box-shadow:var(--glow)}
.card h3{margin:6px 0 8px}
.footer{padding:40px 0;border-top:1px solid var(--muted);color:var(--sub')}
.badge{font-size:12px;padding:6px 10px;border:1px solid var(--muted);border-radius:999px;background:rgba(255,255,255,.03);color:var(--sub)}
#app{display:grid;grid-template-columns:240px 1fr;gap:16px}
.sidebar{position:sticky;top:72px;height:calc(100vh - 88px);padding-bottom:24px}
.navbtn{display:block;width:100%;text-align:left;margin:6px 0;padding:12px 14px;border-radius:12px;border:1px solid var(--muted);background:#0c1512;color:var(--ink);cursor:pointer}
.navbtn.active{background:rgba(0,224,144,.1);border-color:var(--brand)}
.view{display:none}
.view.active{display:block;animation:fade .25s ease}
@keyframes fade{from{opacity:.6;transform:translateY(6px)}to{opacity:1;transform:none}}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--muted)}
.row{display:flex;gap:10px;align-items:center}
.kpi{display:flex;align-items:baseline;gap:10px}
.kpi b{font-size:calc(28px*var(--fontScale))}
.toast{position:fixed;right:18px;bottom:18px;background:#0b1411;border:1px solid var(--muted);padding:12px 16px;border-radius:12px;display:none;z-index:40}
.show{display:block}
.color{width:28px;height:28px;border-radius:999px;border:1px solid var(--muted);cursor:pointer}
.color input{opacity:0;width:0;height:0}
.high-contrast{--panel:#0b0b0b;--muted:#2a2a2a;--ink:#ffffff;--sub:#d0d0d0}
.tools-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.tile{background:#0c1512;border:1px solid var(--muted);border-radius:16px;padding:14px;cursor:pointer;transition:transform .12s}
.tile:hover{transform:translateY(-2px)}
.flashcard{display:flex;align-items:center;justify-content:center;height:220px;background:#0c1512;border:1px solid var(--muted);border-radius:16px;cursor:pointer;font-weight:600}
.grid-match{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.match-item{background:#0c1512;border:1px solid var(--muted);border-radius:12px;padding:10px;cursor:pointer;text-align:center}
.choice{background:#0c1512;border:1px solid var(--muted);border-radius:12px;padding:10px;cursor:pointer}
.choice.correct{border-color:#00e090}
.choice.wrong{border-color:#b21d1d}
#caMini{position:fixed;left:16px;bottom:16px;z-index:25}
.center{min-height:60vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px}
.fadeUp{animation:fadeUp .4s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<nav class="nav">
  <div class="container row">
    <div class="brand">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120"><rect x="8" y="8" width="104" height="104" rx="22" fill="#08110e" stroke="#00E090" stroke-width="6"/><path d="M34 68l13-26 12 16 9-7 18 26" fill="none" stroke="#16B4DF" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <strong>ClassAid</strong>
      <span class="badge">Early Access</span>
    </div>
    <div class="row" style="gap:10px">
      <a class="small" href="#" onclick="navigate('')">Home</a>
      <a class="btn alt" id="toLogin" href="javascript:void(0)">Log in</a>
      <a class="btn" id="toApp" href="javascript:void(0)">Open the App</a>
    </div>
  </div>
</nav>

<!-- HOME -->
<section id="screen-home" class="screen" style="display:block">
  <header class="hero fadeUp">
    <div class="container">
      <span class="badge">New • SPA (no 404s)</span>
      <h1>Modern, fast, and distraction‑proof.</h1>
      <p class="lead">Classes, assignments, GPA, timers, flashcards, matching, and multiple‑choice — all inside the app. Blooket/Kahoot/Quizlet open in new tabs.</p>
      <div class="cards">
        <div class="card"><h3>Plan smarter</h3><p>Color‑coded classes, inline edits, and a dashboard showing what’s next.</p></div>
        <div class="card"><h3>Study faster</h3><p>Import sets. Practice Flashcards, Match, MCQ, or rush for points.</p></div>
        <div class="card"><h3>Customize</h3><p>Readable fonts, line height, high‑contrast, and your own accent color.</p></div>
      </div>
    </div>
  </header>
  <footer class="footer">
    <div class="container small">© 2025 ClassAid • SPA build</div>
  </footer>
</section>

<!-- LOGIN -->
<section id="screen-login" class="screen" style="display:none">
  <main class="container" style="max-width:640px">
    <div class="card">
      <h2>Welcome</h2>
      <p class="small">Create a local account (no server) or sign in to your local profile.</p>
      <div class="input"><input id="email" placeholder="you@school.edu" type="email"></div>
      <div class="input"><input id="name" placeholder="Your name"></div>
      <div class="input"><input id="pass" placeholder="Passphrase (min 6)" type="password"></div>
      <div class="row"><button class="btn alt" id="signup">Create account</button><button class="btn" id="signin">Sign in</button></div>
      <p class="small">Password is hashed and stored locally. Export your data anytime.</p>
    </div>
  </main>
</section>

<!-- APP -->
<section id="screen-app" class="screen" style="display:none">
  <main class="container" id="app">
    <aside class="sidebar">
      <button class="navbtn active" data-view="dash">Dashboard</button>
      <button class="navbtn" data-view="classes">Classes</button>
      <button class="navbtn" data-view="assignments">Assignments</button>
      <button class="navbtn" data-view="gpa">GPA</button>
      <button class="navbtn" data-view="study">Study Games</button>
      <button class="navbtn" data-view="essay">Essay Helper</button>
      <button class="navbtn" data-view="tools">Tools</button>
      <button class="navbtn" data-view="settings">Settings</button>
    </aside>
    <section>
      <div class="view active card" id="view-dash"><h2>Welcome back <span id="who" class="badge"></span></h2><p class="small">Upcoming assignments and GPA at a glance.</p><div id="dashUpcoming" class="small"></div></div>
      <div class="view card" id="view-classes">
        <h2>Classes</h2>
        <div class="row"><input id="clsName" placeholder="Class name"><input id="clsCred" type="number" placeholder="Credits" min="0" step="0.5"><label class="color"><input type="color" id="clsColor" value="#00e090"></label><button class="btn alt" id="addClass">Add</button></div>
        <table><thead><tr><th>Color</th><th>Name</th><th>Cr</th><th></th></tr></thead><tbody id="clsRows"></tbody></table>
      </div>
      <div class="view card" id="view-assignments">
        <h2>Assignments</h2>
        <div class="row"><input id="aTitle" placeholder="Assignment"><select id="aClass"></select><input id="aDue" type="datetime-local"><button class="btn alt" id="addA">Add</button></div>
        <table><thead><tr><th>Class</th><th>Title</th><th>Due</th><th>Status</th><th></th></tr></thead><tbody id="aRows"></tbody></table>
      </div>
      <div class="view card" id="view-gpa">
        <h2>GPA</h2>
        <div class="kpi"><b id="gpaOut">0.00</b> <span class="small">Current GPA</span></div>
        <div class="row"><select id="gClass"></select><input id="gPct" type="number" placeholder="Grade %"><button class="btn alt" id="addG">Log</button></div>
        <table><thead><tr><th>Class</th><th>%</th><th>Pts</th><th>Cr</th><th></th></tr></thead><tbody id="gRows"></tbody></table>
      </div>
      <div class="view card" id="view-study">
        <h2>Study games</h2>
        <div class="cards">
          <div class="card" style="grid-column:1/-1"><h3>Create / import a set</h3><div class="row"><input id="setName" placeholder="Set name"><label class="color" title="Set color"><input type="color" id="setColor" value="#35c995"></label><button class="btn alt" id="addSet">Add set</button><label class="btn ghost" style="cursor:pointer">Import CSV/Quizlet<input id="importSet" type="file" accept=".txt,.csv" style="display:none"></label></div><p class="small">Paste <code>term - definition</code>, <code>term,definition</code>, or alternating lines (Quizlet export).</p></div>
          <div class="card"><h3>Your sets</h3><ul id="setList" class="small"></ul></div>
          <div class="card"><h3>Play</h3><div class="row"><select id="playSet"></select><button class="btn alt" id="pFlash">Flashcards</button><button class="btn alt" id="pMatch">Match</button><button class="btn alt" id="pMCQ">Multiple Choice</button><button class="btn alt" id="pRush">Quick Points</button></div><div id="playArea" style="margin-top:14px"></div></div>
          <div class="card"><h3>Game Hub (opens official sites)</h3><div class="tools-grid"><a class="tile" target="_blank" rel="noopener" href="https://www.blooket.com/">Blooket</a><a class="tile" target="_blank" rel="noopener" href="https://quizlet.com/">Quizlet</a><a class="tile" target="_blank" rel="noopener" href="https://kahoot.it/">Kahoot!</a></div><p class="small">These sites block iframes; new tabs are the reliable way.</p></div>
        </div>
      </div>
      <div class="view card" id="view-essay">
        <h2>Essay helper</h2>
        <textarea id="essay" rows="8" style="width:100%"></textarea>
        <div class="row"><button class="btn alt" id="rewrite">Humanize</button><button class="btn alt" id="outline">Outline</button></div>
        <pre id="out" class="small"></pre>
      </div>
      <div class="view card" id="view-tools">
        <h2>Tools</h2>
        <div class="row">
          <div class="card" style="flex:1"><h3>Pomodoro</h3><div class="row"><input id="pDur" type="number" value="25" style="width:90px"> min <button id="pStart" class="btn alt">Start</button><button id="pStop" class="btn alt">Stop</button></div><p id="pOut" class="kpi"><b>25:00</b> <span class="small">Focus</span></p></div>
          <div class="card" style="flex:1"><h3>Quick notes</h3><div class="row"><input id="qText" placeholder="Note"><button id="qAdd" class="btn alt">Add</button></div><ul id="qList" class="small"></ul></div>
        </div>
      </div>
      <div class="view card" id="view-settings">
        <h2>Settings</h2>
        <div class="cards">
          <div class="card"><h3>Theme</h3><div class="row"><label>Font size <input id="sFont" type="range" min="0.85" max="1.5" step="0.05"></label></div><div class="row"><label>Line height <input id="sLh" type="range" min="1.3" max="1.9" step="0.05"></label></div><div class="row"><label>Accent color <input id="sAccent" type="color"></label></div><div class="row"><label><input id="sContrast" type="checkbox"> High contrast</label></div></div>
          <div class="card"><h3>Data</h3><div class="row"><button id="exportBtn" class="btn alt">Export backup</button><label class="btn alt" style="cursor:pointer">Import<input id="importFile" type="file" accept="application/json" style="display:none"></label></div></div>
          <div class="card"><h3>Account</h3><p class="small">Local-only account. <button class="btn alt" id="btnLogout">Log out</button></p></div>
        </div>
      </div>
    </section>
  </main>
  <button class="btn alt" id="caMini" style="display:none">Sticky Notes</button>
</section>

<div id="toast" class="toast"></div>
<script>
// Hash router (no 404s)
const routes = {
  '': () => show('home'),
  '#/login': () => show('login'),
  '#/app': () => { authGuard(); show('app') },
};
function navigate(hash){ history.pushState(null,'',hash); (routes[hash]||routes[''])(); }
window.addEventListener('popstate', ()=> (routes[location.hash]||routes[''])());

// Utilities
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = m => { const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200) };
function show(view){ $$('.screen').forEach(el=>el.style.display='none'); $('#screen-'+view).style.display='block'; }
function sha256(str){ const enc=new TextEncoder().encode(str); return crypto.subtle.digest('SHA-256',enc).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')); }

// Auth (local)
function authGuard(){ const email = localStorage.getItem('ca:current'); if(!email){ navigate('#/login'); } else { $('#who').textContent = JSON.parse(localStorage.getItem('ca:user:'+email)||'{}').name || ''; } }
async function signup(){ const email=$('#email').value.trim(), name=$('#name').value.trim(), pass=$('#pass').value; if(!email||!name||pass.length<6) return alert('Fill all fields (min 6)'); const passhash=await sha256(pass); const user={email,name,passhash,created:Date.now(),settings:{fontScale:1,accent:'#00e090',contrast:false,lh:1.55}}; localStorage.setItem('ca:user:'+email, JSON.stringify(user)); localStorage.setItem('ca:current', email); navigate('#/app'); }
async function signin(){ const email=$('#email').value.trim(), pass=$('#pass').value; const raw=localStorage.getItem('ca:user:'+email); if(!raw) return alert('No account. Create one.'); const u=JSON.parse(raw); const passhash=await sha256(pass); if(passhash!==u.passhash) return alert('Wrong passphrase'); localStorage.setItem('ca:current', email); navigate('#/app'); }
function logout(){ localStorage.removeItem('ca:current'); navigate('#/login'); }

// Per-user DB
function ns(){ const email = localStorage.getItem('ca:current'); return 'ca:'+email+':'; }
const DB = { get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(ns()+k)) ?? d }catch{ return d }}, set:(k,v)=>localStorage.setItem(ns()+k, JSON.stringify(v)) };

// Theme
const root = document.documentElement;
function loadSettings(){ const email=localStorage.getItem('ca:current'); const u=JSON.parse(localStorage.getItem('ca:user:'+email)||'{}'); return Object.assign({fontScale:1,accent:'#00e090',contrast:false,lh:1.55'}, u.settings||{}); }
let settings = {fontScale:1,accent:'#00e090',contrast:false,lh:1.55};
function applyTheme(){ root.style.setProperty('--fontScale', settings.fontScale); root.style.setProperty('--lh', settings.lh); root.style.setProperty('--brand', settings.accent); document.body.classList.toggle('high-contrast', !!settings.contrast); }
function saveSettings(){ const email=localStorage.getItem('ca:current'); const u=JSON.parse(localStorage.getItem('ca:user:'+email)||'{}'); u.settings=settings; localStorage.setItem('ca:user:'+email, JSON.stringify(u)); }

// App state
let classes=[], grades=[], tasks=[], notes=[], sets=[];

function loadAll(){
  settings = loadSettings(); applyTheme();
  classes = DB.get('classes', []);
  grades  = DB.get('grades',  []);
  tasks   = DB.get('tasks',   []);
  notes   = DB.get('quicknotes', []);
  sets    = DB.get('sets',    []);
  renderAll();
}

function renderAll(){ renderClasses(); renderGrades(); renderTasks(); renderNotes(); renderSets(); renderDash(); bindNav(); }

// DASHBOARD
function renderDash(){ const upcoming=tasks.filter(t=>!t.done).slice(0,5); $('#dashUpcoming').innerHTML = upcoming.length?('<ul>'+upcoming.map(t=>`<li><b>${classes[t.c]?.n||'General'}</b>: ${t.t} — <span class="small">${new Date(t.d).toLocaleString()}</span></li>`).join('')+'</ul>'):'<p>No upcoming work 🎉</p>'; }
function bindNav(){ $$('.navbtn').forEach(btn=>{ btn.onclick=()=>{ $$('.navbtn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $$('.view').forEach(v=>v.classList.remove('active')); $('#view-'+btn.dataset.view).classList.add('active'); }; }); }

// CLASSES
function renderClasses(){
  $('#clsRows').innerHTML = classes.map((c,i)=>`<tr>
   <td><div style="width:16px;height:16px;border-radius:50%;background:${c.color||'#00e090'}"></div></td>
   <td contenteditable data-i="${i}" class="cedit">${c.n}</td>
   <td contenteditable data-i="${i}" data-field="cr" class="cedit">${c.cr||1}</td>
   <td><button data-i="${i}" class="btn alt rmC">x</button></td></tr>`).join('');
  const opts = classes.map((c,i)=>`<option value="${i}">${c.n}</option>`).join('');
  $('#aClass').innerHTML = '<option value="">Class…</option>'+opts; $('#gClass').innerHTML = '<option value="">Class…</option>'+opts;
  DB.set('classes', classes);
  $$('.rmC').forEach(b=>b.onclick=()=>{classes.splice(+b.dataset.i,1);renderClasses();renderGrades();renderTasks();});
  $$('.cedit').forEach(cell=>{ cell.onblur=()=>{ const i=+cell.dataset.i; if(cell.dataset.field==='cr'){ classes[i].cr=+cell.textContent||1 } else { classes[i].n=cell.textContent.trim() } DB.set('classes',classes); renderGrades(); renderTasks(); }; });
}
$('#addClass').onclick=()=>{ const n=$('#clsName').value.trim(), cr=+$('#clsCred').value||1, color=$('#clsColor').value||'#00e090'; if(!n) return; classes.push({n,cr,color}); renderClasses(); $('#clsName').value=''; $('#clsCred').value=''; };

// GPA
const pts = p => p>=93?4:p>=90?3.7:p>=87?3.3:p>=83?3:p>=80?2.7:p>=77?2.3:p>=73?2:p>=70?1.7:p>=67?1.3:p>=65?1:0;
function renderGrades(){
  $('#gRows').innerHTML = grades.map((g,i)=>`<tr><td>${classes[g.c]?.n||'?'}</td><td contenteditable data-i="${i}" class="gedit">${g.p}</td><td>${pts(g.p)}</td><td>${classes[g.c]?.cr||1}</td><td><button data-i="${i}" class="btn alt rmG">x</button></td></tr>`).join('');
  const s=grades.reduce((a,g)=>{const cr=classes[g.c]?.cr||1;return{w:a.w+pts(g.p)*cr,c:a.c+cr}},{w:0,c:0}); $('#gpaOut').textContent=s.c?(s.w/s.c).toFixed(2):'0.00';
  DB.set('grades',grades);
  $$('.rmG').forEach(b=>b.onclick=()=>{grades.splice(+b.dataset.i,1);renderGrades();});
  $$('.gedit').forEach(cell=>{ cell.onblur=()=>{ const i=+cell.dataset.i; grades[i].p=+cell.textContent||0; DB.set('grades',grades); renderGrades(); }; });
}
$('#addG').onclick=()=>{ const c=+$('#gClass').value; const p=+$('#gPct').value; if(isNaN(c)||isNaN(p)) return; grades.push({c,p}); renderGrades(); $('#gPct').value=''; };

// ASSIGNMENTS
function renderTasks(){
  tasks.sort((a,b)=>new Date(a.d)-new Date(b.d));
  $('#aRows').innerHTML = tasks.map((t,i)=>`<tr>
    <td><span style="display:inline-flex;align-items:center;gap:8px"><span style="width:12px;height:12px;border-radius:50%;background:${classes[t.c]?.color||'#00e090'}"></span>${classes[t.c]?.n||''}</span></td>
    <td contenteditable data-i="${i}" class="tedit">${t.t}</td>
    <td>${new Date(t.d).toLocaleString()}</td>
    <td>${t.done?'✅':'⏳'}</td><td><button data-i="${i}" class="btn alt dn">${t.done?'Undo':'Done'}</button></td></tr>`).join('');
  DB.set('tasks',tasks);
  $$('.dn').forEach(b=>b.onclick=()=>{const i=+b.dataset.i;tasks[i].done=!tasks[i].done;renderTasks();});
  $$('.tedit').forEach(cell=>{ cell.onblur=()=>{ const i=+cell.dataset.i; tasks[i].t=cell.textContent.trim(); DB.set('tasks',tasks); }; });
  renderDash();
}
$('#addA').onclick=async()=>{ const t=$('#aTitle').value.trim(), c=+$('#aClass').value, d=$('#aDue').value; if(!t||!d) return; tasks.push({t,c:isNaN(c)?null:c,d,done:false}); renderTasks(); $('#aTitle').value=''; $('#aDue').value=''; };

// NOTES + POMODORO
function renderNotes(){ $('#qList').innerHTML = notes.map((n,i)=>`<li>${n.t} <button class='btn alt rmN' data-i='${i}' style='padding:4px 8px;margin-left:6px'>x</button></li>`).join(''); DB.set('quicknotes', notes); $$('.rmN').forEach(b=>b.onclick=()=>{notes.splice(+b.dataset.i,1);renderNotes()}); }
$('#qAdd').onclick=()=>{ const t=$('#qText').value.trim(); if(!t) return; notes.push({t,at:Date.now()}); $('#qText').value=''; renderNotes(); };
let pTimer=null, pEnd=0; function tickPomodoro(){ const left = Math.max(0, pEnd - Date.now()); const m = Math.floor(left/60000).toString().padStart(2,'0'); const s = Math.floor((left%60000)/1000).toString().padStart(2,'0'); $('#pOut').innerHTML = `<b>${m}:${s}</b> <span class='small'>Focus</span>`; if(left<=0){ clearInterval(pTimer); pTimer=null; toast('Time! Take a break.'); } }
$('#pStart').onclick=()=>{ const mins = +$('#pDur').value || 25; pEnd = Date.now() + mins*60000; tickPomodoro(); clearInterval(pTimer); pTimer=setInterval(tickPomodoro, 250); };
$('#pStop').onclick=()=>{ clearInterval(pTimer); pTimer=null; $('#pOut').innerHTML = `<b>${(+$('#pDur').value||25).toString().padStart(2,'0')}:00</b> <span class='small'>Focus</span>`; };
renderNotes();

// STUDY SETS + GAMES
function renderSets(){ $('#setList').innerHTML = sets.map((s,i)=>`<li><b style="color:${s.color}">${s.name}</b> — ${s.items.length} terms <button class='btn alt' onclick='window.__editSet(${i})' style='padding:4px 8px;margin-left:6px'>Edit</button></li>`).join(''); $('#playSet').innerHTML = sets.map((s,i)=>`<option value="${i}">${s.name}</option>`).join(''); DB.set('sets',sets); }
window.__editSet = (i)=>{ const s = sets[i]; const lines = s.items.map(x=>`${x.t} - ${x.d}`).join('\n'); const text = prompt('Edit terms (term - definition per line):', lines); if(text==null) return; s.items = parseItems(text); renderSets(); };
function parseItems(text){ const out=[]; const rows=text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean); for(let j=0;j<rows.length;j++){ const r=rows[j]; if(r.includes(' - ')){ const [t,...rest]=r.split(' - '); out.push({t:t.trim(), d:rest.join(' - ').trim()}); continue; } if(r.includes(',')){ const [t,...rest]=r.split(','); out.push({t:t.trim(), d:rest.join(',').trim()}); continue; } } if(out.length===0){ for(let j=0;j<rows.length;j+=2){ const t=rows[j], d=rows[j+1]||''; if(t) out.push({t,d}); } } return out; }
$('#addSet').onclick=()=>{ const name=$('#setName').value.trim(); if(!name) return; const color=$('#setColor').value||'#35c995'; sets.push({name,color,items:[]}); renderSets(); $('#setName').value=''; };
$('#importSet').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const text=r.result; const name=prompt('Name this set:' , f.name.replace(/\.(txt|csv)$/i,''))||'Imported'; sets.push({name,color:'#35c995',items:parseItems(text)}); renderSets(); }; r.readAsText(f); };
renderSets();

function el(tag, attrs={}, html=''){ const x=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>x.setAttribute(k,v)); x.innerHTML=html; return x; }
function sample(arr, n){ const a=[...arr]; const out=[]; while(a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

$('#pFlash').onclick=()=>{ const s=sets[+$('#playSet').value]; if(!s||s.items.length===0){ toast('Add terms first'); return; } const items=[...s.items]; let i=0,side=0; $('#playArea').innerHTML=''; const card=el('div',{'class':'flashcard',style:`border-color:${s.color}`},''); const stat=el('div',{'class':'small'},''); const btns=el('div',{'class':'row'},'<button class="btn alt" id="prev">Prev</button><button class="btn alt" id="flip">Flip</button><button class="btn alt" id="next">Next</button><button class="btn ghost" id="shuffle">Shuffle</button>'); $('#playArea').append(card,stat,btns); function draw(){ const it=items[i]; card.textContent = side?it.d:it.t; stat.textContent=(i+1)+'/'+items.length; } draw(); card.onclick=()=>{side^=1;draw()}; btns.querySelector('#flip').onclick=()=>{side^=1;draw()}; btns.querySelector('#prev').onclick=()=>{i=(i-1+items.length)%items.length;side=0;draw()}; btns.querySelector('#next').onclick=()=>{i=(i+1)%items.length;side=0;draw()}; btns.querySelector('#shuffle').onclick=()=>{items.sort(()=>Math.random()-0.5);i=0;side=0;draw()}; };

$('#pMatch').onclick=()=>{ const s=sets[+$('#playSet').value]; if(!s||s.items.length<4){ toast('Need at least 4 terms'); return; } const picks=sample(s.items, Math.min(8, s.items.length)); const terms=picks.map(x=>({k:x.t,v:x.d,type:'t'})); const defs=picks.map(x=>({k:x.t,v:x.d,type:'d'})); const board=[...terms,...defs].sort(()=>Math.random()-0.5); $('#playArea').innerHTML=''; const grid=el('div',{'class':'grid-match'},''); $('#playArea').append(grid); let first=null, matched=0, start=Date.now(); board.forEach((it)=>{ const tile=el('div',{'class':'match-item','data-k':it.k},it.type==='t'?it.k:it.v); tile.onclick=()=>{ if(tile.classList.contains('done')) return; tile.style.borderColor=getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#00e090'; if(!first){ first=tile; } else { if(first.getAttribute('data-k')===tile.getAttribute('data-k') && first!==tile){ first.classList.add('done'); tile.classList.add('done'); first.style.opacity=0.5; tile.style.opacity=0.5; matched+=1; if(matched===picks.length){ const sec=Math.round((Date.now()-start)/1000); toast('Match complete in '+sec+'s'); } } else { const a=first; setTimeout(()=>{ a.style.borderColor=''; tile.style.borderColor=''; },280); } first=null; } }; grid.appendChild(tile); }); };

$('#pMCQ').onclick=()=>{ const s=sets[+$('#playSet').value]; if(!s||s.items.length<4){ toast('Need at least 4 terms'); return; } const items=[...s.items]; items.sort(()=>Math.random()-0.5); let q=0,score=0,limit=Math.min(10,items.length); $('#playArea').innerHTML=''; const ask=el('div',{},''), choices=el('div',{},''), meta=el('div',{'class':'small'},''); $('#playArea').append(ask,choices,meta); function draw(){ const it=items[q]; ask.innerHTML='<h3>'+it.t+'</h3>'; const opts=sample(items.filter(x=>x!==it),3).map(x=>x.d); opts.push(it.d); opts.sort(()=>Math.random()-0.5); choices.innerHTML=opts.map(o=>`<div class='choice'>${o}</div>`).join(''); choices.querySelectorAll('.choice').forEach(c=>c.onclick=()=>{ if(c.textContent===it.d){ c.classList.add('correct'); score++; } else { c.classList.add('wrong'); } setTimeout(()=>{ q++; if(q>=limit){ meta.textContent='Score: '+score+'/'+limit; toast('MCQ finished: '+score+'/'+limit); } else draw(); },420); }); meta.textContent='Question '+(q+1)+'/'+limit+' — Score '+score; } draw(); };

$('#pRush').onclick=()=>{ const s=sets[+$('#playSet').value]; if(!s||s.items.length<4){ toast('Need at least 4 terms'); return; } const items=[...s.items]; let idx=0,points=0,streak=0; $('#playArea').innerHTML=''; const ask=el('div',{},''), opts=el('div',{},''), meta=el('div',{'class':'small'},''); $('#playArea').append(ask,opts,meta); function draw(){ const it=items[idx%items.length]; ask.innerHTML='<h3>'+it.t+'</h3>'; const choices=sample(items.filter(x=>x!==it),3).map(x=>x.d); choices.push(it.d); choices.sort(()=>Math.random()-0.5); opts.innerHTML=choices.map(o=>`<div class='choice'>${o}</div>`).join(''); opts.querySelectorAll('.choice').forEach(c=>c.onclick=()=>{ if(c.textContent===it.d){ streak++; points+=10*streak; c.classList.add('correct'); } else { streak=0; c.classList.add('wrong'); } setTimeout(()=>{ idx++; draw(); },340); }); meta.textContent='Points: '+points+' — Streak: '+streak; } draw(); };

// Essay helper (basic local transforms)
$('#rewrite').onclick=()=>{ const t=$('#essay').value; if(!t.trim()) return; const out=t.replace(/ very /gi,' ').replace(/really /gi,''); $('#out').textContent = out + "\n\n(Quick pass: trimmed fillers)"; };
$('#outline').onclick=()=>{ const t=$('#essay').value; if(!t.trim()) return; const lines=t.split(/\n+/).filter(Boolean); const bullets=lines.map((l,i)=>`${i+1}. ${l.slice(0,80)}...`).join('\n'); $('#out').textContent = 'Outline\n' + bullets; };

// Sticky notes overlay (non-blocking)
(function(){
  let env=null,z=2147483600; const KEY='classaid_notes';
  function read(){ try{ return JSON.parse(localStorage.getItem(KEY))||{notes:[]} }catch{ return {notes:[]} } }
  function write(v){ localStorage.setItem(KEY, JSON.stringify(v)) }
  function ensure(){
    if(env) return env;
    const root=document.createElement('div'); Object.assign(root.style,{position:'fixed',inset:'0',pointerEvents:'none',zIndex:2147483647,display:'none'}); document.documentElement.appendChild(root);
    const bar=document.createElement('div'); bar.style.cssText='position:fixed;right:16px;top:16px;background:#0d1311;border:1px solid #1b2622;color:#e8f2ed;padding:8px 10px;border-radius:12px;display:flex;gap:8px;align-items:center;pointer-events:auto;z-index:'+(z+100); bar.innerHTML='<b>ClassAid Notes</b>';
    const add=document.createElement('button'); add.textContent='New'; add.style.cssText='padding:6px 10px;border-radius:10px;border:1px solid #1b2622;background:#101614;color:#e8f2ed';
    const hide=document.createElement('button'); hide.textContent='Hide'; hide.style.cssText='padding:6px 10px;border-radius:10px;border:1px solid #1b2622;background:#101614;color:#e8f2ed';
    bar.appendChild(add); bar.appendChild(hide); root.appendChild(bar);
    function make(n){
      const el=document.createElement('div'); Object.assign(el.style,{position:'fixed',left:(n.x||60)+'px',top:(n.y||80)+'px',width:'240px',background:'#fff8c6',color:'#1a1a1a',border:'1px solid #d8c96a',borderRadius:'8px',boxShadow:'0 10px 30px rgba(0,0,0,.35)',padding:'8px',pointerEvents:'auto',zIndex:(++z)});
      el.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><input class="tt" style="border:none;background:transparent;font-weight:700;width:160px" value="'+(n.t||'Note')+'"><div><button class="pin" style="border:none;background:transparent;margin-right:6px" title="Bring to front">📌</button><button class="x" style="border:none;background:transparent;font-weight:700" title="Delete">×</button></div></div><textarea class="bd" style="width:100%;height:140px;border:none;background:transparent">'+(n.b||'')+'</textarea>';
      root.appendChild(el);
      let drag=false,dx=0,dy=0; const handle=el.querySelector('.tt');
      function bring(){ el.style.zIndex=++z }
      handle.addEventListener('mousedown',e=>{drag=true;bring();dx=e.clientX-parseInt(el.style.left);dy=e.clientY-parseInt(el.style.top);document.body.style.userSelect='none'});
      window.addEventListener('mousemove',e=>{ if(!drag) return; el.style.left=(e.clientX-dx)+'px'; el.style.top=(e.clientY-dy)+'px'; });
      window.addEventListener('mouseup',()=>{ if(drag){ drag=false; document.body.style.userSelect=''; save(); } });
      el.addEventListener('mousedown',bring);
      el.querySelector('.pin').onclick=bring;
      el.querySelector('.x').onclick=()=>{ const s=read(); s.notes=s.notes.filter(x=>x!==n); write(s); el.remove(); };
      el.querySelector('.bd').oninput=save;
      el.querySelector('.tt').oninput=save;
    }
    function save(){
      const state={notes:Array.from(document.querySelectorAll('textarea.bd')).map(ta=>{const el=ta.closest('div');return{x:parseInt(el.style.left),y:parseInt(el.style.top),t:el.querySelector('.tt').value,b:ta.value}})};
      write(state);
    }
    add.onclick=()=>{ const n={x:80+Math.random()*60,y:120+Math.random()*60,t:'Note',b:''}; const s=read(); s.notes.push(n); write(s); make(n); };
    hide.onclick=()=>{ root.style.display='none' };
    read().notes.forEach(make);
    env={root};
    return env;
  }
  window.ClassAidOverlay={toggle:()=>{ const r=ensure().root; r.style.display=(r.style.display==='none')?'block':'none'; }};
})();

// Settings
function bindSettings(){
  const sFont=$('#sFont'), sLh=$('#sLh'), sAccent=$('#sAccent'), sContrast=$('#sContrast');
  sFont.value=settings.fontScale; sLh.value=settings.lh; sAccent.value=settings.accent; sContrast.checked=!!settings.contrast;
  [sFont,sLh,sAccent,sContrast].forEach(el=>el.oninput=()=>{ settings.fontScale=parseFloat(sFont.value); settings.lh=parseFloat(sLh.value); settings.accent=sAccent.value; settings.contrast=sContrast.checked; applyTheme(); saveSettings(); });
}

// Export / Import
function exportAll(){ const data={classes,grades,tasks,quicknotes:notes,settings,sets,version:12}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'classaid-backup.json'}); a.click(); URL.revokeObjectURL(a.href); }
function importAll(file){ const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); ['classes','grades','tasks','quicknotes','sets'].forEach(k=>{ if(Array.isArray(d[k])){ const ref={classes,grades,tasks,quicknotes:notes,sets}[k]; ref.splice(0,ref.length,...d[k]); } }); if(d.settings){ Object.assign(settings,d.settings); applyTheme(); saveSettings(); } renderAll(); }catch{ alert('Invalid JSON') } }; r.readAsText(file); }

// Wire up Home buttons
$('#toLogin').onclick=()=>navigate('#/login');
$('#toApp').onclick=()=>navigate('#/app');
$('#signup').onclick=signup;
$('#signin').onclick=signin;
$('#btnLogout').onclick=logout;
$('#exportBtn').onclick=exportAll;
$('#importFile').onchange=e=>importAll(e.target.files[0]);
setTimeout(()=>{ const mini=$('#caMini'); mini.style.display='inline-flex'; mini.onclick=()=>window.ClassAidOverlay.toggle(); }, 600);

// Initial route
(routes[location.hash]||routes[''])();
if(location.hash==='#/app'){ authGuard(); }
bindSettings();
loadAll();
</script>
</body>
</html>
